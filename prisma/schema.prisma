// Shipco Logistics - Prisma Schema
// Roles: ADMIN, MERCHANT, HUB_OPERATOR only.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ENUMS ============

enum Role {
  MERCHANT
  ADMIN
  HUB_OPERATOR
}

enum ShipmentStatus {
  PENDING
  PICKED_UP
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
}

enum TransactionType {
  CREDIT
  DEBIT
  DEPOSIT
  SHIPMENT_PAYMENT
  REFUND
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
}

enum ShipmentType {
  LOCAL
  INTERNATIONAL
}

enum PaymentStatus {
  PAID
  UNPAID
}

// ============ MODELS ============

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  phone         String?
  passwordHash  String?   @map("password_hash")
  role          Role      @default(MERCHANT)
  emailVerified DateTime? @map("email_verified_at")
  image         String?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  accounts        Account[]
  sessions        Session[]
  wallet          Wallet?
  shipments       Shipment[]
  merchantProfile MerchantProfile?
}

model MerchantProfile {
  id             String   @id @default(cuid())
  userId         String   @unique @map("user_id")
  businessName   String   @map("business_name")
  businessAddress String  @map("business_address") @db.Text
  taxId          String?  @map("tax_id")
  category       String?  // Business category
  verified       Boolean  @default(false)
  bankDetails    Json?    @map("bank_details")   // { bankName, accountNumber, accountName }
  utilityBillUrl String?  @map("utility_bill_url")
  apiKey         String?  @map("api_key")  // Mock API key for merchant integrations
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Wallet {
  id        String   @id @default(cuid())
  userId    String   @unique @map("user_id")
  balance   Decimal  @default(0) @db.Decimal(12, 2)
  currency  String   @default("NGN")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([userId])
}

model Transaction {
  id          String            @id @default(cuid())
  walletId    String            @map("wallet_id")
  type        TransactionType
  amount      Decimal           @db.Decimal(12, 2)
  status      TransactionStatus @default(PENDING)
  description String?           @db.Text
  reference   String?           @unique
  shipmentId  String?           @map("shipment_id")
  metadata    Json?
  createdAt   DateTime          @default(now()) @map("created_at")

  wallet   Wallet    @relation(fields: [walletId], references: [id], onDelete: Cascade)
  shipment Shipment? @relation(fields: [shipmentId], references: [id], onDelete: SetNull)

  @@index([walletId])
  @@index([shipmentId])
  @@index([reference])
}

model Shipment {
  id              String         @id @default(cuid())
  userId          String         @map("user_id")
  trackingNumber  String         @unique @map("tracking_number")
  type            ShipmentType
  status          ShipmentStatus @default(PENDING)
  paymentStatus   PaymentStatus  @default(UNPAID) @map("payment_status")
  weightKg        Decimal        @map("weight_kg") @db.Decimal(8, 2)
  priceAmount     Decimal        @map("price_amount") @db.Decimal(12, 2)
  currency        String         @default("NGN")
  category        String?
  dimensions      String?        @db.Text

  senderName      String         @map("sender_name")
  senderPhone     String         @map("sender_phone")
  senderAddress   String         @map("sender_address") @db.Text
  senderCity      String         @map("sender_city")
  senderCountry   String         @map("sender_country")

  recipientName   String         @map("recipient_name")
  recipientPhone  String         @map("recipient_phone")
  recipientAddress String        @map("recipient_address") @db.Text
  recipientCity   String         @map("recipient_city")
  recipientCountry String        @map("recipient_country")

  notes           String?        @db.Text
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  deliveredAt     DateTime?      @map("delivered_at")

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions  Transaction[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model PricingRates {
  id          String       @id @default(cuid())
  shipmentType ShipmentType @map("shipment_type")
  ratePerKg   Decimal      @map("rate_per_kg") @db.Decimal(10, 2)
  currency   String       @default("NGN")
  minWeightKg Decimal     @default(0) @map("min_weight_kg") @db.Decimal(8, 2)
  maxWeightKg Decimal?    @map("max_weight_kg") @db.Decimal(8, 2)
  isActive   Boolean      @default(true) @map("is_active")
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")
}
